class: center, middle

# SPA kari

### AAA

.right[Kensuke Nagae (@kyanny)]

.right[Aug 18 2015, Ginza.rb]

---

# 話せそうなネタ

* なぜシングルページアプリケーションなのか
  * モバイル・ネイティブ対抗のためには古きよきやり方では無理だったから
* Backbone.js のウソ
  * 背骨ではなくただの骨。骨格の組み方を知らないと人体としてありえないモノを組んでしまう
* Chaplin.js
  * なぜ @reuse はイマイチか、そしてフロントエンド開発のアキレス腱 build/deploy ツール密結合のダメさ
* Marionette.js とコンポーネント志向
* React の素晴らしさはどこにあるか
  * △バーチャルDOMだからはやい
  * ○「毎回画面を全部書き換える」古きよき単純なアーキテクチャへ回帰したことがすごい
  * シンプルなアーキテクチャのパフォーマンス面での問題を実装で解決したのがバーチャルDOM（それ自体技術的には高度ですごいが、そもそものアーキテクチャ的な正しい判断があってこそ活きる）

---

# おさらい: なぜSPAなのか

* モバイルネイティブアプリの反応速度に対抗するため
  * https://mobile.twitter.com/
* Web技術でなんとかしたいというニーズ

---

# おさらい: なぜクライアントサイドフレームワークなのか

* 原理的にはjQueryでAjaxでよいはずだが、素朴すぎる
* そこそこ規模が大きく込み入ったアプリケーションの開発に耐えうるアーキテクチャ

---

# QuipperにおけるSPA

* 気がついたらSPAだらけになっていた
  * SPAかふつうのウェブアプリケーションか、は議論にすらならなかった
  * Web開発者がモバイルネイティブアプリ開発者より圧倒的に多数だったので自然と

---

# Quipperにおけるクライアントサイドフレームワーク

* Backbone
  * 最初に採用、最近まで現役
* Chaplin
  * 過去に採用されアプリを二つ作ったが
* Marionette
  * 主力アプリ三つすべてこれ（Backboneからの移行含む）
* React
* Backbone/Marionetteアプリの一機能を別で実装し連携して動く

---

# QuipperにおけるBackbone

* 2013年春ごろにiOS開発者がWebにコンバートして一人でアプリを作る際に採用
* 具体的にどのような議論を経てBackboneでSPAというアーキテクチャが採用されたかは不明
* 狙いどおり応答性の高いアプリだが、コードベースは厄介

---

# Backbone（のウソ）

* 背骨ではなく、ただの骨
* 正しい骨格の組み上げ方を知らないと、いびつな形に

---

# Chaplin

* Backboneをベースとする
* 規約多め（Railsに少し似ている）
* ビルドまわりなど、不自由さ
* @reuse の扱いづらさ
* 実質キャッシュなので

---

# QuipperにおけるChaplin

* 2013年初夏から日本で小学生向けタブレット学習サービスを作る際に採用
* 過去にBackboneで大規模SPA開発を経験した人の知見
  * 「素のBackboneだけで開発すると破綻するので避けるべし」
* 開発チームは彼以外にSPAの知見がなかったので彼が見つけてきたChaplinを選んだ
  * 当時MarionetteはChaplinとどっこいのマイナーさで、Angularは流行り始めていたが避けた
* その後2014年に開始した別プロジェクトでも再び採用したがプロジェクト中止

---

# Marionette

* これもBackboneをベースとする
* LayoutViewのわかりやすさと汎用性
* 規約はゆるいがmoduleによってきれいなアーキテクチャを維持できる

---

# QuipperにおけるMarionette

* 主力アプリがBackboneで残りはRails+jQueryだったが、遅さが問題になった
* Chaplinを採用したチームから「次も選ぶほどではない」というフィードバック
* Backboneの経験値はたまったのでそれベースのMarionetteが選ばれた
* いろいろアドバンテージを活かせた結果、主力アプリすべてMarionetteを採用

---

# Chaplin vs Marionette

* 思想の違い
  * フレームワーク側で頑張ろうとするChaplin
  * 便利なパーツを用意して開発者に任せるMarionette
* リスク承知でレールを外れざるをえないのがフロントエンドの世界
* 無茶して規約を迂回するリスクを払わずに済むMarionetteのほうがよい

---

# QuipperにおけるReact

---

# SPA時代のAPIのあり方

* [例えば OSFA な API をやめる](http://blog.kyanny.me/entry/2014/03/06/%E4%BE%8B%E3%81%88%E3%81%B0_OSFA_%E3%81%AA_API_%E3%82%92%E3%82%84%E3%82%81%E3%82%8B)
* Railsのscaffoldで作ったような「きれいな」APIはSPAからは扱いづらい
  * 画面を組み立てるためには複数のリソースが必要になることがほとんど
  * それぞれ個別のエンドポイントを叩いてレスポンスを待っていたら応答性が犠牲になるしコードももろくなる
* SPA側に都合の良いデータを返すAPIを作るほうが結果的に楽
  * 単純なサーバサイド（Ruby）+込み入ったクライアントサイド（JavaScript） vs 込み入ったサーバサイド（Ruby）+単純なクライアントサイド（JavaScript）

